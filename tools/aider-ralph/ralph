#!/usr/bin/env bash
#
# ralph - Seamless AI Coding Loop
# Uses local LLM (qwen2.5-coder) for autonomous project building
#
set -euo pipefail

# Config
MODEL="qwen2.5-coder:14b"
OLLAMA_URL="http://localhost:11434"
RALPH_DIR=".ralph"
MAX_ITERATIONS=50

# Colors (only for display, never sent to LLM)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

log() { echo -e "${BLUE}[ralph]${NC} $1" >&2; }
success() { echo -e "${GREEN}[âœ“]${NC} $1" >&2; }
warn() { echo -e "${YELLOW}[!]${NC} $1" >&2; }
error() { echo -e "${RED}[âœ—]${NC} $1" >&2; exit 1; }

# Check dependencies
check_deps() {
    command -v ollama &>/dev/null || error "ollama not found"
    command -v aider &>/dev/null || error "aider not found"
    command -v jq &>/dev/null || error "jq not found"
    curl -s "$OLLAMA_URL/api/tags" &>/dev/null || error "ollama not running"
}

# Query LLM (clean, no colors)
query_llm() {
    local system="$1"
    local prompt="$2"
    
    local response
    response=$(curl -s "$OLLAMA_URL/api/chat" \
        -d "$(jq -n \
            --arg model "$MODEL" \
            --arg system "$system" \
            --arg prompt "$prompt" \
            '{
                model: $model,
                messages: [
                    {role: "system", content: $system},
                    {role: "user", content: $prompt}
                ],
                stream: false,
                options: {temperature: 0.2, num_ctx: 16384}
            }')" 2>/dev/null)
    
    echo "$response" | jq -r '.message.content // empty' 2>/dev/null
}

# Phase 1: Get project description
get_description() {
    echo "" >&2
    echo "============================================" >&2
    echo "  ralph - AI Coding Loop (local LLM)" >&2  
    echo "============================================" >&2
    echo "" >&2
    
    if [[ -n "${1:-}" ]]; then
        echo "$1"
        return
    fi
    
    echo -e "${BOLD}What do you want to build?${NC}" >&2
    read -r -p "> " desc
    [[ -z "$desc" ]] && error "No description provided"
    echo "$desc"
}

# Phase 2: Ask clarifying questions
ask_questions() {
    local desc="$1"
    
    log "Generating questions..."
    
    local questions
    questions=$(query_llm \
        "You are a software architect. Ask 3-4 brief clarifying questions about a project. Number them. Be concise." \
        "Project: $desc

Ask 3-4 questions about: language/framework, key features, input/output format, any constraints.")

    if [[ -z "$questions" ]]; then
        echo "$desc"
        return
    fi
    
    echo "" >&2
    echo -e "${YELLOW}Quick questions:${NC}" >&2
    echo "$questions" >&2
    echo "" >&2
    echo "(Answer briefly or press Enter to skip)" >&2
    echo "" >&2
    
    local answers=""
    local num=1
    while IFS= read -r line; do
        if [[ "$line" =~ ^[0-9] ]]; then
            read -r -p "$line > " answer </dev/tty
            [[ -n "$answer" ]] && answers+="$line Answer: $answer. "
            ((num++))
        fi
    done <<< "$questions"
    
    # Return clean text
    echo "Build: $desc. Details: $answers"
}

# Phase 3: Generate task spec
generate_tasks() {
    local spec_text="$1"
    local project_dir="$2"
    
    log "Generating task list (this takes ~60 seconds)..."
    
    mkdir -p "$project_dir/$RALPH_DIR"
    
    local system='You are a technical lead. Output ONLY valid JSON, no markdown.

Format:
{
  "project": "name",
  "description": "summary",
  "tasks": [
    {"id": "T001", "title": "title", "description": "what to do", "acceptance": ["testable criteria"], "passes": false}
  ]
}

Rules:
- 5-12 atomic tasks, ordered by dependency
- Each task = one aider session (5-15 min)
- Acceptance criteria must be verifiable
- Include setup task first, integration test last
- ONLY JSON output, nothing else'

    local json
    json=$(query_llm "$system" "Create task list for: $spec_text")
    
    # Try to extract JSON if wrapped in markdown
    if ! echo "$json" | jq . &>/dev/null; then
        json=$(echo "$json" | sed -n '/^{/,/^}/p' | head -100)
    fi
    
    # Validate
    if ! echo "$json" | jq . &>/dev/null; then
        warn "JSON generation failed. Retrying with simpler prompt..."
        
        json=$(query_llm \
            "Output only valid JSON. No explanation." \
            "Create a task list JSON for: $spec_text

{\"project\":\"name\",\"tasks\":[{\"id\":\"T001\",\"title\":\"...\",\"description\":\"...\",\"acceptance\":[\"...\"],\"passes\":false}]}")
        
        if ! echo "$json" | jq . &>/dev/null; then
            error "Could not generate valid task spec. Try a clearer description."
        fi
    fi
    
    echo "$json" > "$project_dir/$RALPH_DIR/prd.json"
    
    # Create progress file
    echo "# Ralph Progress Log" > "$project_dir/$RALPH_DIR/progress.txt"
    echo "Started: $(date)" >> "$project_dir/$RALPH_DIR/progress.txt"
    
    # Create AGENTS.md
    [[ ! -f "$project_dir/AGENTS.md" ]] && echo "# Project Notes" > "$project_dir/AGENTS.md"
    
    local count
    count=$(echo "$json" | jq '.tasks | length')
    success "Generated $count tasks"
    echo "" >&2
    echo -e "${CYAN}Tasks:${NC}" >&2
    echo "$json" | jq -r '.tasks[] | "  [\(.id)] \(.title)"' >&2
    echo "" >&2
}

# Phase 4: Execute loop
run_loop() {
    local project_dir="$1"
    cd "$project_dir"
    
    # Init git
    [[ ! -d .git ]] && git init -q && git add -A 2>/dev/null && git commit -m "init" -q 2>/dev/null || true
    
    local iteration=0
    while [[ $iteration -lt $MAX_ITERATIONS ]]; do
        ((iteration++))
        
        local task
        task=$(jq -r 'first(.tasks[] | select(.passes == false)) | @json' "$RALPH_DIR/prd.json" 2>/dev/null)
        
        if [[ -z "$task" || "$task" == "null" ]]; then
            echo "" >&2
            success "ALL DONE! ðŸŽ‰"
            return 0
        fi
        
        local id title desc criteria
        id=$(echo "$task" | jq -r '.id')
        title=$(echo "$task" | jq -r '.title')
        desc=$(echo "$task" | jq -r '.description')
        criteria=$(echo "$task" | jq -r '.acceptance | join("; ")')
        
        echo "" >&2
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
        echo -e "${CYAN}[$id]${NC} $title (iteration $iteration)" >&2
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
        
        local prompt="TASK: $title

$desc

ACCEPTANCE CRITERIA: $criteria

Complete this task fully. Create all needed files. Test that criteria pass."

        log "Running aider..."
        
        if aider --model "ollama_chat/$MODEL" \
                 --no-show-model-warnings \
                 --auto-commits \
                 --yes-always \
                 --message "$prompt" 2>&1; then
            
            # Mark done
            jq "(.tasks[] | select(.id == \"$id\")).passes = true" "$RALPH_DIR/prd.json" > tmp.json
            mv tmp.json "$RALPH_DIR/prd.json"
            
            echo "[$id] $title - DONE $(date '+%H:%M')" >> "$RALPH_DIR/progress.txt"
            success "Task $id complete"
        else
            warn "Task $id had issues"
            echo "[$id] $title - REVIEW NEEDED $(date '+%H:%M')" >> "$RALPH_DIR/progress.txt"
            
            read -r -p "Continue? [Y/n] " choice </dev/tty
            [[ "$choice" == "n" || "$choice" == "N" ]] && break
        fi
        
        sleep 1
    done
}

# Resume session
resume() {
    local dir="${1:-.}"
    [[ ! -f "$dir/$RALPH_DIR/prd.json" ]] && error "No session in $dir"
    
    local done total
    done=$(jq '[.tasks[] | select(.passes)] | length' "$dir/$RALPH_DIR/prd.json")
    total=$(jq '.tasks | length' "$dir/$RALPH_DIR/prd.json")
    
    log "Resuming: $done/$total complete"
    run_loop "$dir"
}

# Status
status() {
    local dir="${1:-.}"
    [[ ! -f "$dir/$RALPH_DIR/prd.json" ]] && echo "No session found" && return
    
    jq -r '.tasks[] | (if .passes then "âœ“" else "â—‹" end) + " [\(.id)] \(.title)"' "$dir/$RALPH_DIR/prd.json"
    
    local done total
    done=$(jq '[.tasks[] | select(.passes)] | length' "$dir/$RALPH_DIR/prd.json")
    total=$(jq '.tasks | length' "$dir/$RALPH_DIR/prd.json")
    echo ""
    echo "Progress: $done/$total"
}

# Main
main() {
    check_deps
    
    case "${1:-}" in
        --resume|-r) resume "${2:-.}" ;;
        --status|-s) status "${2:-.}" ;;
        --here|-h)
            shift
            local desc=$(get_description "${1:-}")
            local full=$(ask_questions "$desc")
            generate_tasks "$full" "."
            read -r -p "Start building? [Y/n] " c </dev/tty
            [[ "$c" != "n" && "$c" != "N" ]] && run_loop "."
            ;;
        --help)
            echo "ralph - AI Coding Loop"
            echo ""
            echo "  ralph              Interactive"
            echo "  ralph \"desc\"       Start with description"
            echo "  ralph --here       Add to current project"
            echo "  ralph --resume     Resume session"
            echo "  ralph --status     Show progress"
            ;;
        *)
            local desc=$(get_description "${1:-}")
            
            # Project name from description
            local default_name=$(echo "$desc" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '-' | cut -c1-30 | sed 's/-$//')
            read -r -p "Project directory [$default_name]: " project_dir </dev/tty
            project_dir="${project_dir:-$default_name}"
            
            mkdir -p "$project_dir"
            
            local full=$(ask_questions "$desc")
            generate_tasks "$full" "$project_dir"
            
            read -r -p "Start building? [Y/n] " choice </dev/tty
            [[ "$choice" != "n" && "$choice" != "N" ]] && run_loop "$project_dir"
            ;;
    esac
}

main "$@"
