#!/usr/bin/env bash
#
# ralph - Seamless AI Coding Loop
# Uses local LLM for autonomous project building
#

# Strict mode with error handling
set -euo pipefail

# Configuration
MODEL='qwen2.5-coder:14b'
OLLAMA_URL='http://localhost:11434'
RALPH_DIR='.ralph'
MAX_ITERATIONS=50

# ANSI Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Logging functions
log() { echo -e "${BLUE}[ralph]${NC} $1" >&2; }
success() { echo -e "${GREEN}[âœ“]${NC} $1" >&2; }
warn() { echo -e "${YELLOW}[!]${NC} $1" >&2; }
error() { echo -e "${RED}[âœ—]${NC} $1" >&2; exit 1; }

# Check dependencies
check_deps() {
    command -v ollama >/dev/null 2>&1 || error 'ollama not found'
    command -v aider >/dev/null 2>&1 || error 'aider not found'
    command -v jq >/dev/null 2>&1 || error 'jq not found'
    curl -s "$OLLAMA_URL/api/tags" >/dev/null 2>&1 || error 'ollama not running'
}

# Query LLM
query_llm() {
    local system="$1"
    local prompt="$2"
    
    log "Querying LLM:"
    log "System: $system"
    log "Prompt: $prompt"
    
    local response
    response=$(curl -s -X POST "$OLLAMA_URL/api/chat" \
        -H 'Content-Type: application/json' \
        -d "{
            \"model\": \"$MODEL\",
            \"messages\": [
                {\"role\": \"system\", \"content\": \"$system\"},
                {\"role\": \"user\", \"content\": \"$prompt\"}
            ],
            \"stream\": false
        }")
    
    log "Raw Response:"
    log "$response"
    
    local content
    content=$(echo "$response" | jq -r '.message.content // empty')
    
    log "Extracted Content:"
    log "$content"
    
    echo "$content"
}

# Get project description
get_description() {
    if [[ -n "${1:-}" ]]; then
        echo "$1"
        return
    fi
    
    echo -n 'What do you want to build? '
    read -r desc
    [[ -z "$desc" ]] && error 'No description provided'
    echo "$desc"
}

# Ask clarifying questions
ask_questions() {
    local desc="$1"
    
    local questions
    questions=$(query_llm \
        'Software architect asking clarifying project questions' \
        "Project: $desc. Provide 2-3 quick clarification points.")
    
    echo "$desc. $questions"
}

# Generate tasks
generate_tasks() {
    local spec_text="$1"
    local project_dir="$2"
    
    mkdir -p "$project_dir/$RALPH_DIR"
    
    local default_tasks='{
        "project": "default_project",
        "description": "Web application",
        "tasks": [
            {
                "id": "T001",
                "title": "Project Setup",
                "description": "Initialize project structure",
                "acceptance": ["Project created", "Basic structure in place"],
                "passes": false
            },
            {
                "id": "T002",
                "title": "Initial Implementation",
                "description": "Create basic functionality",
                "acceptance": ["Basic code written", "Minimal working version"],
                "passes": false
            }
        ]
    }'
    
    local json
    json=$(query_llm \
        'Technical lead generating project tasks' \
        "Create 5-7 tasks for: $spec_text")
    
    if ! echo "$json" | jq . >/dev/null 2>&1; then
        warn 'Task generation failed. Using default tasks.'
        json="$default_tasks"
    fi
    
    echo "$json" > "$project_dir/$RALPH_DIR/prd.json"
    
    # Create supporting files
    echo '# Ralph Progress Log' > "$project_dir/$RALPH_DIR/progress.txt"
    echo "Started: $(date)" >> "$project_dir/$RALPH_DIR/progress.txt"
    
    [[ ! -f "$project_dir/AGENTS.md" ]] && echo '# Project Notes' > "$project_dir/AGENTS.md"
    
    # Display tasks
    local count
    count=$(echo "$json" | jq '.tasks | length')
    success "Generated $count tasks"
    echo '' >&2
    echo -e "${CYAN}Tasks:${NC}" >&2
    echo "$json" | jq -r '.tasks[] | "  [\(.id)] \(.title)"' >&2
    echo '' >&2
}

# Main execution loop
run_loop() {
    local project_dir="$1"
    cd "$project_dir" || exit 1
    
    # Initialize git if not exists
    [[ ! -d .git ]] && git init -q && git add . && git commit -m 'Initial commit' -q
    
    local iteration=0
    while ((iteration < MAX_ITERATIONS)); do
        ((iteration++))
        
        local task
        task=$(jq -r 'first(.tasks[] | select(.passes == false)) | @json' "$RALPH_DIR/prd.json" 2>/dev/null)
        
        if [[ -z "$task" || "$task" == 'null' ]]; then
            success 'ALL TASKS COMPLETED! ðŸŽ‰'
            return 0
        fi
        
        local id title desc criteria
        id=$(echo "$task" | jq -r '.id')
        title=$(echo "$task" | jq -r '.title')
        desc=$(echo "$task" | jq -r '.description')
        criteria=$(echo "$task" | jq -r '.acceptance | join("; ")')
        
        log "Running task: $title"
        
        if aider --model "ollama_chat/$MODEL" \
                 --no-show-model-warnings \
                 --auto-commits \
                 --yes-always \
                 --message "TASK: $title. $desc. CRITERIA: $criteria" 2>&1; then
            
            jq "(.tasks[] | select(.id == \"$id\")).passes = true" "$RALPH_DIR/prd.json" > tmp.json
            mv tmp.json "$RALPH_DIR/prd.json"
            
            echo "[$id] $title - COMPLETED" >> "$RALPH_DIR/progress.txt"
            success "Task $id completed"
        else
            warn "Task $id encountered issues"
            echo "[$id] $title - NEEDS REVIEW" >> "$RALPH_DIR/progress.txt"
            break
        fi
    done
}

# Main function
main() {
    check_deps
    
    case "${1:-}" in
        --resume)
            run_loop "${2:-.}"
            ;;
        --status)
            jq -r '.tasks[] | (if .passes then "âœ“" else "â—‹" end) + " [\(.id)] \(.title)"' "${2:-.}/$RALPH_DIR/prd.json"
            ;;
        *)
            local desc
            desc=$(get_description "${1:-}")
            local full_desc
            full_desc=$(ask_questions "$desc")
            
            local project_name
            project_name=$(echo "$desc" | tr '[:upper:]' '[:lower:]' | tr -cs '[:alnum:]' '-' | cut -c1-30)
            
            mkdir -p "$project_name"
            generate_tasks "$full_desc" "$project_name"
            
            read -r -p 'Start building? [Y/n] ' choice
            [[ "${choice,,}" != 'n' ]] && run_loop "$project_name"
            ;;
    esac
}

main "$@"